<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<link rel="import" href="../olos-param/olos-param.html">

<!--
Envelope controls a signal value over time.

Max value = 1
Min value = 0

Based on the NexusUI Envelope, New BSD License Ben Taylor,
Jesse Allison, Yemin Oh, Sebastien Piquemal, Andrew Bernstein

@element olos-envelope
@blurb 
@status alpha
@homepage 
-->
<dom-module id="olos-envelope">
  <link rel="import" type="css" href="olos-envelope.css">
  <template>

    <div id="container" class="olos-container">
    </div>

    <div class="controls">
      <paper-icon-button id="butt" icon="settings-power" on-click="start"></paper-icon-button>
    </div>

    <olos-param id="triggerParam"></olos-param>

  </template>
  <script>
    (function (params) {
      Polymer({
        is: 'olos-envelope',
        properties: {
          color: {
            type: String,
            value: '#00FF7F',
            notify: true
          },
          // breakpoints: [],
          /**
           *  Duration of the envelope in seconds.
           *
           *  @attribute duration
           *  @type Number
           *  @default 1.0
           */
          duration: {
            type: Number,
            value: 1,
            observer: 'durationChanged'
          },
          height: {
            type: Number,
            value: 220,
            notify: true
          },
          /**
           *  Web Audio Gain Node
           *
           *  @attribute inputAudio
           *  @type GainNode
           */
          inputAudio: {
            value: null,
            notify: true
          },

          /**
           *  <a href="http://nexusosc.com/api/#nexusui-api-envelope" target="_blank"> Nexus UI envelope object</a>
           *  @type {Object}
           */
          nexusEl: { value: null },
          output: {
            value: null,
            notify: true
          },
          play: { notify: true },
          publicMethods: {
            type: Array,
            value: function () {
              return [
                'setup',
                'onData',
                'start',
                'triggerAttack',
                'triggerRelease'
              ];
            }
          },
          rootfolder: {
            type: String,
            value: '../olos-envelope/',
            notify: true
          },
          src: { notify: true },
          /**
           *  triggerParam contains the input data passed by another module.
           *  
           *  @attribute triggerParam
           *  @type Object
           *  @default ''
           */
          triggerParam: {
            value: null,
            notify: true
          },
          width: {
            type: Number,
            value: 300,
            notify: true
          }
        },
        // gain node for control
        ready: function () {
          var self = this;
          this._audioContext = audioContext;
          // nexus element
          this.nexusEl = nx.add('envmulti');
          this.nexusEl.colors.accent = this.color;
          // this.nexusEl.colors.fill = '#EBF6FF';

          Polymer.dom(document.body).removeChild(this.nexusEl.canvas);

          Polymer.dom(this.$.container).appendChild(this.nexusEl.canvas);
          this.nexusEl.canvas.style.setProperty('width', '100%');
          this.nexusEl.canvas.style.setProperty('height', '100%');
          this.set('nexusEl.canvas.width', this.width);
          this.set('nexusEl.canvas.height', this.height);

          this.$.container.style.setProperty('width', this.width);
          this.$.container.style.setProperty('height', this.height);

          self.nexusEl.draw();
          self.inputAudio = this.output = this._audioContext.createGain();
          self.signal = new Tone.Signal()
          self.signal.connect(self.inputAudio.gain);

          self.setup();
          self._initParams();

          setTimeout(function() {
            self.resize();
            self.nexusEl.init();
          }, 20);

        },
        _initParams: function () {
          var self = this;
          self.triggerParam = self.$.triggerParam;
          self.triggerParam.scope = self;
          self.triggerParam.callback = function(a, b) {
            self.onData(a, b);
          }
        },
        setup: function () {
          // default duration
          this.duration = 1;
          this.set('signal.value', 0);
        },
        durationChanged: function () {
          // change the nexusUI animation
          this.set('nexusEl.duration', this.duration * 1000);
        },
        start: function (timeFromNow) {
          var timeFromNow = timeFromNow instanceof Number ? timeFromNow : 0;
          var self = this;
          var time = this._audioContext.currentTime + timeFromNow;
          setTimeout(function () {
            self.nexusEl.start();
          }, timeFromNow * 1000);
          ;
          // trigger the envelope
          this.signal.cancelScheduledValues(time);
          this.signal.setValueAtTime(this.signal.value, time);
          for (var i = 0; i <= this.nexusEl.val.points.length; i++) {
            // finally, ramp to 0
            var pointY = 0;
            var pointX = 1;
            if (i < this.nexusEl.val.points.length) {
              pointY = this.nexusEl.val.points[i].y;
              pointX = this.nexusEl.val.points[i].x;
            }
            var xTime = pointX * this.duration;
            if (i < 3) {
              this.signal.linearRampToValueAtTime(pointY, time + xTime);
            } else {
              this.signal.linearRampToValueAtTime(pointY, time + xTime, 0.1);
            }
          }
        },
        /**
         *  Only trigger the attack portion of the envelope, hold at Sustain value.
         *  
         *  @method triggerAttack
         *  @param  Number timeFromNow time in seconds to schedule this event in the future
         */
        triggerAttack: function (timeFromNow) {
          var t = timeFromNow || 0;
          var time = this._audioContext.currentTime + t;
          this.signal.cancelScheduledValues(time);
          this.signal.setValueAtTime(this.signal.value, time);
          // update UI
          for (var i = 0; i <= 2; i++) {
            // finally, ramp to 0
            var pointY = 0;
            var pointX = 1;
            if (i < this.nexusEl.val.points.length) {
              pointY = this.nexusEl.val.points[i].y;
              pointX = this.nexusEl.val.points[i].x;
            }
            var xTime = pointX * this.duration;
            // also update output gain
            if (i < 2) {
              this.signal.linearRampToValueAtTime(pointY, time + xTime);
            } else {
              this.signal.linearRampToValueAtTime(pointY, time + xTime, 0.5);
            }
          }
        },
        /**
         *  Only trigger the release portion of the envelope.
         *  
         *  @method triggerRelease
         *  @param  Number timeFromNow time in seconds to schedule this event in the future
         */
        triggerRelease: function (timeFromNow) {
          var t = timeFromNow || 0;
          var time = this._audioContext.currentTime + t;
          this.signal.cancelScheduledValues(time);
          this.signal.setValueAtTime(this.signal.value, time);
          for (var i = 2; i <= this.nexusEl.val.points.length; i++) {
            // finally, ramp to 0
            var pointY = 0;
            var pointX = 1;
            if (i < this.nexusEl.val.points.length) {
              pointY = this.nexusEl.val.points[i].y;
              pointX = this.nexusEl.val.points[i].x;
            }
            var xTime = pointX * this.duration;
            // also update output gain
            if (i < this.nexusEl.val.points.length) {
              this.signal.linearRampToValueAtTime(pointY, time + xTime);
            } else {
              this.signal.linearRampToValueAtTime(pointY, time + xTime, 0.5);
            }
          }
        },
        /**
         *  This event fires when new data is received.
         *
         *  @method onData
         *  @param  Array value an array of values
         *  @param  Number time audioContext time
         */
        onData: function (values, time) {
          var values = arguments[0];
          var time = arguments[1];

          for (var i = 0; i < values.length; i++) {
            if (values[i] > 0) {
              this.start(time);
            }
          }
        },
        resize: function () {
          this.set('nexusEl.width', this.$.container.offsetWidth);
          this.set('nexusEl.height', this.$.container.offsetHeight);
          this.set('nexusEl.canvas.width', this.$.container.offsetWidth);
          this.set('nexusEl.canvas.height', this.$.container.offsetHeight);
          this.nexusEl.canvas.style.setProperty('width', this.$.container.offsetWidth);
          this.nexusEl.canvas.style.setProperty('height', this.$.container.offsetHeight);
          this.set('nexusEl.actualWid', this.$.container.offsetWidth);
          this.set('nexusEl.actualHgt', this.$.container.offsetHeight);
          this.nexusEl.draw();
        },
        animate: function () {
        },
        // to do
        // percentDone = 
        // this.nexusEl.val.index = 
        dispose: function () {
          var self = this;
          // destroy nexus element
          self.nexusEl.destroy();
          // remove audio elements
          var nodes = ['inputAudio'];
          for (var i = 0; i < nodes.length; i++) {
            try {
              var node = self[nodes[i]];
              node.disconnect();
              node = null;
            } catch (e) {
            }
          }
        }
      });
    }());
  </script>
</dom-module>